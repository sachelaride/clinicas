

{% extends 'clinica/base.html' %} {# Estende o template base para herdar a estrutura e estilos #}

{% block content %} {# Início do bloco de conteúdo principal da página #}
  <div class="card"> {# Contêiner principal do formulário com estilo de card #}
    <div class="card-body"> {# Corpo do card #}
      <h2 class="card-title"> {# Título do formulário, que muda dependendo do modo (criar/editar) #}
        {% if edit_mode %} {# Verifica se está no modo de edição #}
          <i class="fa-solid fa-pencil"></i> Editar Paciente {# Ícone e texto para edição #}
        {% else %} {# Se não estiver no modo de edição, é o modo de criação #}
          <i class="fa-solid fa-plus"></i> Novo Paciente {# Ícone e texto para criação #}
        {% endif %}
      </h2>

      <form method="post"> {# Formulário que envia dados via método POST #}
        {% csrf_token %} {# Token CSRF para proteção contra ataques #}
        
        <div class="row"> {# Linha para organizar os campos do formulário em colunas #}
          {% for field in form %} {# Itera sobre cada campo do formulário Django #}
            <div class="col-md-6 mb-3"> {# Cada campo ocupa metade da largura em telas médias e maiores #}
              {{ field.label_tag }} {# Exibe o rótulo do campo #}
              {{ field }} {# Renderiza o campo do formulário #}
              {% if field.errors %} {# Verifica se há erros para o campo atual #}
                <div class="invalid-feedback d-block"> {# Exibe mensagens de erro de validação #}
                  {{ field.errors|first }} {# Mostra apenas o primeiro erro, se houver #}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <hr> {# Linha divisória #}

        <div class="d-flex justify-content-end gap-2"> {# Contêiner para os botões de ação, alinhados à direita #}
          {# Botão para cancelar a operação e voltar para a lista de pacientes #}
          <a href="{% url 'clinica:paciente_list' %}" class="btn btn-secondary"><i class="fa-solid fa-xmark"></i> Cancelar</a>
          {# Botão para submeter o formulário e salvar as alterações #}
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %} {# Fim do bloco de conteúdo #}

{% block extra_body %} {# Bloco para scripts JavaScript adicionais #}
<script>
  document.addEventListener('DOMContentLoaded', function() { {# Executa o script quando o DOM estiver completamente carregado #}
    // Inicializa Flatpickr para o campo de data de nascimento
    flatpickr("#id_data_nascimento", { {# Seleciona o campo com id 'id_data_nascimento' #}
      dateFormat: "Y-m-d", {# Define o formato da data #}
      locale: "pt", {# Define o idioma para português #}
      maxDate: "today", // Não permite selecionar datas futuras #}
    });

    const form = document.querySelector('form'); {# Seleciona o formulário na página #}
    const fields = form.querySelectorAll('input, select, textarea'); {# Seleciona todos os campos de input, select e textarea dentro do formulário #}

    fields.forEach(field => { {# Itera sobre cada campo selecionado #}
      // Adiciona a classe form-control do Bootstrap se o campo ainda não tiver e não for um SELECT
      if (!field.classList.contains('form-control') && field.tagName !== 'SELECT') {
        field.classList.add('form-control');
      }
      // Adiciona a classe form-select do Bootstrap se o campo for um SELECT e ainda não tiver
      if (field.tagName === 'SELECT' && !field.classList.contains('form-select')) {
        field.classList.add('form-select');
      }

      // Adiciona listeners para eventos de input e change para validação em tempo real
      field.addEventListener('input', function() {
        validateField(this);
      });
      field.addEventListener('change', function() {
        validateField(this);
      });
    });

    // Adiciona listener para o evento de submissão do formulário
    form.addEventListener('submit', function(event) {
      let formIsValid = true; {# Flag para controlar a validade geral do formulário #}
      fields.forEach(field => { {# Itera sobre cada campo para validar antes da submissão #}
        if (!validateField(field)) {
          formIsValid = false; {# Se um campo for inválido, marca o formulário como inválido #}
        }
      });

      if (!formIsValid) {
        event.preventDefault(); {# Previne a submissão padrão do formulário #}
        event.stopPropagation(); {# Impede a propagação do evento para elementos pais #}
      }
      form.classList.add('was-validated'); {# Adiciona a classe para exibir feedback de validação do Bootstrap #}
    });

    // Máscara de CPF
    const cpfField = document.getElementById('id_cpf');
    if (cpfField) {
        cpfField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.substring(0, 11);
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
            }
            e.target.value = value;
        });
    }

    function validateField(field) {
      if (field.checkValidity()) { {# Verifica a validade do campo usando a API de validação HTML5 #}
        field.classList.remove('is-invalid'); {# Remove a classe de inválido #}
        field.classList.add('is-valid'); {# Adiciona a classe de válido #}
        // Remove a mensagem de erro personalizada se existir
        const errorDiv = field.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
          errorDiv.remove();
        }
        return true; {# Retorna true se o campo é válido #}
      } else {
        field.classList.remove('is-valid'); {# Remove a classe de válido #}
        field.classList.add('is-invalid'); {# Adiciona a classe de inválido #}
        // Adiciona ou atualiza a mensagem de erro personalizada
        let errorDiv = field.nextElementSibling;
        if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
          errorDiv = document.createElement('div');
          errorDiv.classList.add('invalid-feedback', 'd-block');
          field.parentNode.insertBefore(errorDiv, field.nextSibling);
        }
        errorDiv.textContent = field.validationMessage || 'Campo obrigatório.'; {# Exibe a mensagem de validação do navegador ou uma mensagem padrão #}
        return false; {# Retorna false se o campo é inválido #}
      }
    }
  });
</script>
{% endblock %} {# Fim do bloco extra_body #}
