{% extends 'clinica/base.html' %}

{% block content %}
  <div class="card">
    <div class="card-body">
      <h2 class="card-title">
        {% if edit_mode %}
          <i class="fa-solid fa-pencil"></i> Editar Tipo de Tratamento
        {% else %}
          <i class="fa-solid fa-plus"></i> Novo Tipo de Tratamento
        {% endif %}
      </h2>

      <form method="post">
        {% csrf_token %}
        
        <div class="row">
          {% for field in form %}
            <div class="col-md-6 mb-3">
              {{ field.label_tag }}
              {{ field }}
              {% if field.errors %}
                <div class="invalid-feedback d-block">
                  {{ field.errors|first }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <hr>

        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'clinica:tipotratamento_list' %}" class="btn btn-secondary"><i class="fa-solid fa-xmark"></i> Cancelar</a>
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_body %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const fields = form.querySelectorAll('input, select, textarea');

    fields.forEach(field => {
      if (!field.classList.contains('form-control') && field.tagName !== 'SELECT') {
        field.classList.add('form-control');
      }
      if (field.tagName === 'SELECT' && !field.classList.contains('form-select')) {
        field.classList.add('form-select');
      }

      field.addEventListener('input', function() {
        validateField(this);
      });
      field.addEventListener('change', function() {
        validateField(this);
      });
    });

    form.addEventListener('submit', function(event) {
      let formIsValid = true;
      fields.forEach(field => {
        if (!validateField(field)) {
          formIsValid = false;
        }
      });

      if (!formIsValid) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });

    function validateField(field) {
      if (field.checkValidity()) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        const errorDiv = field.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
          errorDiv.remove();
        }
        return true;
      } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        let errorDiv = field.nextElementSibling;
        if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
          errorDiv = document.createElement('div');
          errorDiv.classList.add('invalid-feedback', 'd-block');
          field.parentNode.insertBefore(errorDiv, field.nextSibling);
        }
        errorDiv.textContent = field.validationMessage || 'Campo obrigat√≥rio.';
        return false;
      }
    }
  });
</script>
{% endblock %}